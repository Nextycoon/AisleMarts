import { Image } from 'react-native';type Story={id:string;type:'image'|'video'|'mixed';mediaUrl:string;thumbUrl?:string};const inflight=new Set<string>();const done=new Set<string>();
async function prefetchImage(url:string){if(!url||done.has(url)||inflight.has(url))return;inflight.add(url);try{await Image.prefetch(url);}finally{inflight.delete(url);done.add(url);}}
async function prefetchVideo(url:string){try{const { Video } = await import('expo-av');const video=new Video({} as any);await video.loadAsync({uri:url},{shouldPlay:false},false);await video.unloadAsync();}catch{}}
export async function preloadStories(stories:Story[],currentIndex:number,window=3){const targets=stories.slice(currentIndex+1,currentIndex+1+window);for(const s of targets){if(s.thumbUrl)prefetchImage(s.thumbUrl);if(s.type==='image'||s.type==='mixed')prefetchImage(s.mediaUrl);if(s.type==='video'||s.type==='mixed')prefetchVideo(s.mediaUrl);}}
export function makeViewabilityPreloader(getStories:()=>Story[],window=3){return({viewableItems}:{viewableItems:Array<{index?:number}>})=>{const idx=viewableItems?.[0]?.index??0;preloadStories(getStories(),idx,window);};}
